## BLUEPRINT: GESTIÓN DE EDIFICIOS (3-TIER)

**1. Arquitectura & Seguridad**

* **Flujo:** React → Node/Express API → Supabase (Postgres).
* **Acceso DB:** El Backend usa `SERVICE_ROLE_KEY` (acceso total). **Sin RLS**.
* **Auth:** JWT gestionado por Backend (`userId`, `role`, `email`). Passwords con `bcrypt`.
* **Regla de Oro:** El Frontend nunca habla con Supabase. Toda la lógica vive en el Backend.

**2. Esquema de Datos (Supabase)**

* `users`: id (uuid), email (unique), password_hash, role (admin/resident), apartment.
* `amenities`: id, name, capacity, available_from/to (TIME), is_active.
* `bookings`: id, amenity_id, user_id, booking_date (DATE), start_time/end_time (TIME), status (confirmed/cancelled).
* *Constraint:* UNIQUE (amenity_id, booking_date, start_time, end_time) WHERE status='confirmed'.


* `announcements`: id, title, content, priority (low/urgent), is_published.
* `app_settings`: key (PK), value. (Inits: `min_booking_hours_advance: 24`, `max_booking_duration_hours: 4`, `max_active_bookings_per_user: 3`).

**3. Lógica Crítica de Reservas (`booking.service.js`)**
Toda reserva debe validar antes de insertar:

1. Fecha debe ser futura.
2. Anticipación mínima según `app_settings`.
3. No solapamiento de horarios (Overlap check).
4. Usuario no exceda `max_active_bookings_per_user`.
5. Horario dentro del rango `available_from/to` del amenity.
6. Duración no mayor a `max_booking_duration_hours`.

**4. Contrato de API**

* `auth/`: login, register, me.
* `amenities/`: CRUD (Admin: todo / Resident: solo lectura).
* `bookings/`: Resident: CRUD propio / Admin: Ver/cancelar todo.
* `announcements/`: Listar publicados. CRUD (solo Admin).
